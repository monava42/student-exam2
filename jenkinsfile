pipeline {
    agent {
        node { label 'agent1' }
    }

    stages {
        
        stage('Python test'){
            steps {
                sh '''which pip
                      which python
                      pip install -e '.[test]'
                      coverage run -m pytest
                      coverage report
                    '''
            }
        }
        stage('Docker image build'){
            steps {
                sh '''sudo docker build -t agent:${BUILD_TAG}.
                      sudo docker images | grep agent:${BUILD_TAG}
                    '''
            }
        }
        stage('Docker hub authentication'){
            environment {
                LOG = credentials('dockerhub')
            }
            steps {
                sh 'sudo docker login -u ${LOG_USR} -p ${LOG_PSW}'
            }
        }
        stage('Push docker image'){
            steps {
                sh '''sudo docker tag agent:${BUILD_TAG} ${LOG_USR}/monavaft:agent:${BUILD_TAG}
                      sudo docker push ${LOG_USR}/monavaft
                    '''
            }
        }
    }
}
